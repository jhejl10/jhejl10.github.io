<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoom Phone - Call Center Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- Base & Layout --- */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; padding-top: 64px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; } /* Default to auto-fit */
        @media (min-width: 1024px) { .dashboard-grid { grid-template-columns: 3fr 2fr 2fr; } } /* 3 col medium */
        @media (min-width: 1536px) { .dashboard-grid { grid-template-columns: 3fr 2fr 2fr 2fr; } } /* 4 col wide */

        /* --- Header --- */
        .profile-button { background-color: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .profile-button:hover { background-color: #bae6fd; }

        /* --- Draggable Panels --- */
        .dashboard-panel { border-radius: 0.5rem; background-color: white; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); border: 2px solid transparent; transition: border-color 0.2s ease, opacity 0.2s ease, box-shadow 0.2s ease; display: flex; flex-direction: column; }
        .dashboard-panel .panel-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb;}
        .dashboard-panel .panel-header .drag-handle { cursor: grab; margin-left: auto; padding-left: 0.5rem; color: #9ca3af; }
        .dashboard-panel .panel-header .drag-handle:hover { color: #374151; }
        .dashboard-panel .panel-content { flex-grow: 1; overflow-y: auto; max-height: 70vh; /* Scrollable content */ }
        .dashboard-panel .panel-content.hidden { display: none; }
        .dashboard-panel.dragging { cursor: grabbing; opacity: 0.7; border-color: #60a5fa; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .panel-drag-over { border: 2px dashed #60a5fa; }
        .panel-toggle-icon { transition: transform 0.2s ease-in-out; margin-left: 0.5rem; color: #9ca3af; }
        .panel-toggle-icon.collapsed { transform: rotate(-90deg); }

        /* --- Users/Sites Panel --- */
        .site-section { cursor: grab; border: 1px solid #e5e7eb; transition: border-color 0.2s ease, opacity 0.2s ease, box-shadow 0.2s ease; }
        .site-section:hover { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .site-section.dragging { cursor: grabbing; opacity: 0.6; border-color: #93c5fd; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.05); }
        .site-drag-over { border-top: 2px dashed #93c5fd; }
        .site-toggle-icon { transition: transform 0.2s ease-in-out; color: #9ca3af; }
        .site-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background-color: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .site-header:hover .site-toggle-icon { color: #3b82f6; }
        .site-header .site-toggle-icon.collapsed { transform: rotate(-90deg); }
        .user-list.hidden { display: none; }
        .user-list { padding: 0.75rem; }
        .user-item { transition: background-color 0.15s ease-in-out; }
        .user-item-clickable:hover { background-color: #f0f9ff; cursor: pointer; }
        .user-item-content { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .user-info-left { display: flex; align-items: center; overflow: hidden; margin-right: 0.5rem; flex-grow: 1; }
        .user-info-right { display: flex; align-items: center; flex-shrink: 0; }
        .inline-call-info { font-size: 0.75rem; color: #dc2626; margin-right: 0.5rem; display: inline-flex; align-items: center; gap: 0.2rem; background-color: #fee2e2; padding: 0.1rem 0.4rem; border-radius: 0.25rem; }
        .filter-sort-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-bottom: 0.75rem; font-size: 0.875rem; }
        .filter-sort-controls select, .filter-sort-controls input { padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: white; }
        .site-filter-group { border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.5rem; max-height: 100px; overflow-y: auto; }
        .site-filter-group label { display: block; margin-bottom: 0.25rem; cursor: pointer; }
        .site-filter-group input[type="checkbox"] { margin-right: 0.5rem; }


        /* --- Expanded User Detail --- */
        .user-detail-view { background-color: #f8fafc; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; margin-left: -0.75rem; margin-right: -0.75rem; padding: 0.75rem 1rem; /* Removed animation */ }
        .user-detail-view img { border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); width: 48px; height: 48px; }
        .detail-label { font-weight: 500; color: #4b5563; text-align: right; font-size: 0.8rem; }
        .detail-value { color: #1f2937; font-size: 0.8rem; }
        .detail-name-site { font-size: 1rem; font-weight: 600; }
        .detail-site { font-size: 0.75rem; color: #6b7280; margin-left: 0.5rem; }
        .status-message-bubble { background-color: #e0e7ff; color: #4338ca; border-radius: 0.75rem; padding: 0.15rem 0.6rem; display: inline-block; font-style: italic; font-size: 0.75rem; margin-top: 0.1rem; }

        /* --- Active Calls Panel --- */
        .active-call-item { border: 1px solid #e5e7eb; padding: 0.75rem; border-radius: 0.375rem; background-color: white; text-sm; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); cursor: pointer; transition: background-color 0.15s ease; }
        .active-call-item:hover { background-color: #f9fafb; }
        .supervisor-actions { margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed #e5e7eb; display: flex; gap: 0.5rem; }
        .supervisor-actions button { font-size: 0.75rem; padding: 0.2rem 0.5rem; }
        .participant-line { display: flex; justify-content: space-between; align-items: center; }
        .participant-name { font-semibold; color: #1f2937; truncate; }
        .participant-id { color: #6b7280; text-xs; flex-shrink: 0; margin-left: 0.5rem; }

        /* --- Incoming Calls Panel --- */
        .incoming-call-item { border: 1px solid #eab308; padding: 0.75rem; border-radius: 0.375rem; background-color: #fefce8; text-sm; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .incoming-call-item .caller-name { font-semibold; color: #ca8a04; }
        .incoming-call-item .caller-id { color: #a16207; }
        .incoming-call-item .target-info { color: #713f12; }

        /* --- Call Queues Panel --- */
        .queue-member-list { font-size: 0.75rem; color: #4b5563; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed #e5e7eb; }
        .queue-member-list span { display: inline-block; background-color: #f3f4f6; padding: 0.1rem 0.4rem; border-radius: 0.25rem; margin-right: 0.25rem; margin-bottom: 0.25rem; }


        /* --- Summary Stats --- */
        .stats-section { background-color: white; border-radius: 0.5rem; padding: 1rem; margin-top: 1.5rem; /* Added margin top */ box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); }
        .stat-card { text-align: center; }
        .stat-value { font-size: 1.875rem; font-semibold; color: #1f2937; }
        .stat-label { font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; }

        /* --- Inputs & Buttons --- */
        .input-base { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.3rem 0.6rem; font-size: 0.875rem; }
        .search-input { transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .search-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); outline: none; }
        .action-button { padding: 0.3rem 0.8rem; font-size: 0.8rem; border-radius: 0.375rem; transition: background-color 0.2s ease; display: inline-flex; align-items: center; gap: 0.3rem; border: 1px solid transparent; }
        .action-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .call-button { background-color: #22c55e; color: white; border-color: #16a34a; } .call-button:hover:not(:disabled) { background-color: #15803d; }
        .chat-button { background-color: #3b82f6; color: white; border-color: #2563eb; } .chat-button:hover:not(:disabled) { background-color: #1d4ed8; }
        .text-button { background-color: #a855f7; color: white; border-color: #9333ea; } .text-button:hover:not(:disabled) { background-color: #7e22ce; }
        .add-contact-button { background-color: #f0f9ff; color: #0284c7; border-color: #bae6fd; } .add-contact-button:hover:not(:disabled) { background-color: #e0f2fe; }
        .edit-contact-button { background-color: #fef3c7; color: #d97706; border-color: #fde68a; } .edit-contact-button:hover:not(:disabled) { background-color: #fde047; }
        .listen-button { background-color: #60a5fa; color: white; border-color: #3b82f6; } .listen-button:hover:not(:disabled) { background-color: #2563eb; }
        .whisper-button { background-color: #f472b6; color: white; border-color: #ec4899; } .whisper-button:hover:not(:disabled) { background-color: #db2777; }
        .barge-button { background-color: #ef4444; color: white; border-color: #dc2626; } .barge-button:hover:not(:disabled) { background-color: #b91c1c; }
        .retrieve-button { background-color: #14b8a6; color: white; border-color: #0d9488; } .retrieve-button:hover:not(:disabled) { background-color: #0f766e; }
        .save-button { background-color: #10b981; color: white; border-color: #059669; } .save-button:hover:not(:disabled) { background-color: #047857; }

        /* --- Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 50; opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: white; padding: 1.5rem 2rem 2rem 2rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); min-width: 400px; max-width: 600px; transform: scale(0.95); transition: transform 0.2s ease-in-out; position: relative; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-close-btn { position: absolute; top: 0.5rem; right: 0.75rem; background: none; border: none; font-size: 1.75rem; line-height: 1; cursor: pointer; color: #9ca3af; transition: color 0.2s ease; }
        .modal-close-btn:hover { color: #374151; }

        /* --- Loading --- */
        .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.7); display: flex; justify-content: center; align-items: center; z-index: 10; }
        .loading-overlay.hidden { display: none; }

        /* Presence Status Icons */
        .status-icon { width: 1.25em; text-align: center; margin-right: 6px; }
        .status-available { color: #16a34a; } .status-on-call { color: #dc2626; } .status-busy { color: #f97316; } .status-away { color: #eab308; } .status-dnd { color: #ef4444; } .status-in-a-meeting { color: #2563eb; } .status-out-of-office { color: #a855f7; } .status-offline { color: #6b7280; }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-md fixed top-0 left-0 right-0 z-30 h-16 flex items-center">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <h1 class="text-xl font-semibold text-gray-800 flex items-center">
                <i class="fas fa-headset mr-2 text-blue-600"></i> Call Center Dashboard
            </h1>
            <div class="flex items-center space-x-4">
                <div class="text-sm text-gray-600">
                    Last Updated: <span id="last-updated">--:--:--</span>
                </div>
                <button id="my-profile-btn" class="action-button profile-button">
                    <i class="fas fa-user-circle"></i> My Profile
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 mt-4">

        <div id="dashboard-main-grid" class="dashboard-grid">

            <div id="panel-users" class="dashboard-panel" draggable="true">
                 <div class="p-4 border-b border-gray-200 panel-header">
                     <h2 class="text-lg font-semibold text-gray-700">Users / Common Areas</h2>
                     <span class="panel-toggle-icon"><i class="fas fa-chevron-down fa-xs"></i></span>
                     <span class="drag-handle" title="Drag to reorder"><i class="fas fa-grip-vertical"></i></span>
                 </div>
                 <div class="panel-content p-4">
                    <div class="filter-sort-controls">
                        <div class="site-filter-group">
                            <label><input type="checkbox" class="site-filter-checkbox" value="all" checked> All Sites</label>
                            </div>
                        <select id="user-sort" class="input-base">
                            <option value="firstName">Sort by First Name</option>
                            <option value="lastName">Sort by Last Name</option>
                            <option value="extension">Sort by Extension</option>
                            <option value="status">Sort by Status</option>
                        </select>
                        <input type="text" id="user-search" placeholder="Search name/ext..."
                               class="input-base search-input flex-grow">
                    </div>
                    <div id="sites-container" class="space-y-1 relative">
                        <p class="text-gray-500 p-4 text-center">Loading user data...</p>
                         <div id="users-loading" class="loading-overlay hidden">
                             <i class="fas fa-spinner fa-spin text-blue-500 text-3xl"></i>
                         </div>
                    </div>
                 </div>
            </div>

            <div id="panel-calls" class="dashboard-panel" draggable="true">
                <div class="p-4 border-b border-gray-200 panel-header">
                    <h2 class="text-lg font-semibold text-gray-700">Active Calls</h2>
                    <span class="panel-toggle-icon"><i class="fas fa-chevron-down fa-xs"></i></span>
                    <span class="drag-handle" title="Drag to reorder"><i class="fas fa-grip-vertical"></i></span>
                </div>
                <div id="active-calls-container" class="p-4 space-y-3 panel-content">
                    <p class="text-gray-500 text-center py-4">Loading active calls...</p>
                </div>
            </div>

            <div id="panel-incoming" class="dashboard-panel" draggable="true">
                <div class="p-4 border-b border-gray-200 panel-header">
                    <h2 class="text-lg font-semibold text-gray-700">Incoming Calls</h2>
                    <span class="panel-toggle-icon"><i class="fas fa-chevron-down fa-xs"></i></span>
                    <span class="drag-handle" title="Drag to reorder"><i class="fas fa-grip-vertical"></i></span>
                </div>
                <div id="incoming-calls-container" class="p-4 space-y-3 panel-content">
                    <p class="text-gray-500 text-center py-4">No incoming calls.</p>
                </div>
            </div>

            <div id="panel-parked" class="dashboard-panel" draggable="true">
                <div class="p-4 border-b border-gray-200 panel-header">
                    <h2 class="text-lg font-semibold text-gray-700">Parked Calls</h2>
                     <span class="panel-toggle-icon"><i class="fas fa-chevron-down fa-xs"></i></span>
                    <span class="drag-handle" title="Drag to reorder"><i class="fas fa-grip-vertical"></i></span>
                </div>
                <div id="parked-calls-container" class="p-4 space-y-3 panel-content">
                    <p class="text-gray-500 text-center py-4">Loading parked calls...</p>
                </div>
            </div>

             <div id="panel-queues" class="dashboard-panel" draggable="true">
                <div class="p-4 border-b border-gray-200 panel-header">
                    <h2 class="text-lg font-semibold text-gray-700">Call Queues</h2>
                    <span class="panel-toggle-icon"><i class="fas fa-chevron-down fa-xs"></i></span>
                    <span class="drag-handle" title="Drag to reorder"><i class="fas fa-grip-vertical"></i></span>
                </div>
                <div id="call-queues-container" class="p-4 space-y-3 panel-content">
                    <p class="text-gray-500 text-center py-4">Loading queue data...</p>
                </div>
            </div>

            </div>

            <section id="summary-stats" class="stats-section grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stat-card"> <div class="stat-value" id="stat-total-users">0</div> <div class="stat-label">Total Users</div> </div>
                <div class="stat-card"> <div class="stat-value" id="stat-available-users">0</div> <div class="stat-label">Available Users</div> </div>
                <div class="stat-card"> <div class="stat-value" id="stat-on-call-users">0</div> <div class="stat-label">On Call</div> </div>
                <div class="stat-card"> <div class="stat-value" id="stat-active-calls">0</div> <div class="stat-label">Active Calls</div> </div>
            </section>

    </main>

    <div id="call-detail-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" aria-label="Close modal">&times;</button>
            <h3 class="text-lg font-semibold mb-4 text-gray-800">Call Details</h3>
            <div id="call-modal-content" class="space-y-3 text-sm">
                <p class="text-center text-gray-500">Loading call information...</p>
            </div>
            <div id="call-modal-actions" class="mt-6 pt-4 border-t flex justify-end space-x-3">
                 <button class="px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-md hover:bg-gray-300 modal-close-btn-bottom">Close</button>
            </div>
        </div>
    </div>

    <div id="my-profile-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" aria-label="Close modal">&times;</button>
            <h3 class="text-lg font-semibold mb-4 text-gray-800">My Profile & Status</h3>
            <div id="my-profile-modal-content" class="space-y-3 text-sm">
                 <p class="text-center text-gray-500">Loading performance data...</p>
            </div>
             <div class="mt-6 pt-4 border-t flex justify-end">
                 <button class="px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-md hover:bg-gray-300 modal-close-btn-bottom">Close</button>
             </div>
        </div>
    </div>


    <script>
        // --- MOCK DATA GENERATION (Expanded) ---
        const firstNames = ["Alice", "Bob", "Charlie", "Diana", "Ethan", "Fiona", "George", "Hannah", "Isaac", "Jane", "Kevin", "Laura", "Mike", "Nancy", "Oscar", "Penny", "Quincy", "Rachel", "Steve", "Tina", "Ulysses", "Violet", "Walter", "Xena", "Yannick", "Zoe"];
        const lastNames = ["Smith", "Johnson", "Brown", "Prince", "Hunt", "Glenanne", "Costanza", "Abbott", "Newton", "Doe", "Miller", "Davis", "Garcia", "Rodriguez", "Wilson", "Martinez", "Anderson", "Taylor", "Thomas", "Hernandez"];
        const ALL_STATUSES = ['Available', 'On Call', 'Busy', 'Away', 'DND', 'In a Meeting', 'Out of Office', 'Offline']; // Define globally
        const statusMessages = { Busy: "Focusing", DND: "Project deadline", "In a Meeting": "Internal Sync", "Out of Office": "Vacation" };

        let mockSites = [];
        for (let i = 1; i <= 8; i++) {
            mockSites.push({ id: `site${String(i).padStart(2, '0')}`, name: `Site ${String.fromCharCode(64 + i)} (${['Corp', 'Sales', 'Support', 'Dev', 'Ops', 'West', 'East', 'Central'][i-1]})` });
        }

        let mockUsers = [];
        let userCounter = 1;
        mockSites.forEach(site => {
            for (let i = 0; i < 10; i++) {
                const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                const name = `${firstName} ${lastName}`;
                const email = `${firstName.toLowerCase()}.${lastName.toLowerCase()}${userCounter}@example.com`;
                const extension = `${site.id.slice(-2)}${String(i).padStart(2, '0')}`;
                const hasDirect = Math.random() < 0.6;
                const directNumber = hasDirect ? `+1555${Math.floor(1000000 + Math.random() * 9000000)}` : null;
                const status = ALL_STATUSES[Math.floor(Math.random() * ALL_STATUSES.length)];
                const statusMessage = statusMessages[status] && Math.random() < 0.4 ? statusMessages[status] : null;
                const profilePicText = `${firstName.charAt(0)}${lastName.charAt(0)}`;
                const profilePictureUrl = `https://placehold.co/48x48/E2E8F0/A0AEC0?text=${profilePicText}`;
                mockUsers.push({ id: `user${String(userCounter).padStart(3, '0')}`, name, email, extension, directNumber, profilePictureUrl, siteId: site.id, status, statusMessage });
                userCounter++;
            }
        });

        let mockActiveCalls = [
            { callId: 'call_abc', participants: [mockUsers[1].name, '+15551234567'], startTime: Date.now() - 120000, direction: 'Outbound' },
            { callId: 'call_def', participants: [mockUsers[15].name, 'Sales Queue'], startTime: Date.now() - 30000, direction: 'Inbound' },
            { callId: 'call_ghi', participants: [mockUsers[0].name, '+15559876543'], startTime: Date.now() - 65000, direction: 'Inbound' },
            { callId: 'call_jkl', participants: [mockUsers[22].name, '+15553334444'], startTime: Date.now() - 240000, direction: 'Outbound' },
        ];
        mockActiveCalls.forEach(call => { const userParticipant = call.participants.find(p => !p.startsWith('+') && !p.includes('Queue')); if (userParticipant) { const userIndex = mockUsers.findIndex(u => u.name === userParticipant); if (userIndex !== -1) { mockUsers[userIndex].status = 'On Call'; } } });

        // Add members to queues
        let mockCallQueues = [
            { id: 'q01', name: 'Sales Queue', callsWaiting: 2, longestWait: 185, agentsAvailable: 3, agentsBusy: 2, members: [mockUsers[10].id, mockUsers[11].id, mockUsers[12].id, mockUsers[13].id, mockUsers[14].id] },
            { id: 'q02', name: 'Support Queue', callsWaiting: 0, longestWait: 0, agentsAvailable: 5, agentsBusy: 1, members: [mockUsers[20].id, mockUsers[21].id, mockUsers[22].id, mockUsers[23].id, mockUsers[24].id, mockUsers[25].id] },
            { id: 'q03', name: 'Billing Queue', callsWaiting: 1, longestWait: 45, agentsAvailable: 1, agentsBusy: 1, members: [mockUsers[30].id, mockUsers[31].id] },
        ];
        let mockPhonebook = { '+15551234567': { name: 'ACME Corp Main', added: '2024-01-15', notes: 'Primary contact: Jane D.' }, '+15553334444': { name: 'Beta Industries', added: '2024-03-10', notes: '' }, '+15559876543': { name: null, added: null, notes: '' }, /* Unknown */ '+15557778888': { name: 'Gamma Gadgets', added: '2024-04-01', notes: '' } };
        mockUsers.slice(0, 5).forEach(u => { if (u.directNumber) mockPhonebook[u.directNumber] = { name: `${u.name} Direct`, added: '2024-02-01', notes: `Internal - ${u.siteId}` } });
        let mockCallHistory = { '+15551234567': { lastContactDate: '2025-05-01T14:30:00Z', user: mockUsers[0].name }, '+15559876543': null, '+15553334444': { lastContactDate: '2025-04-28T09:15:00Z', user: mockUsers[5].name } };
        let mockParkedCalls = [
            { parkId: 'park_1', parkedBy: mockUsers[4].name, number: '+15557778888', parkTime: Date.now() - 45000, location: '101' },
            { parkId: 'park_2', parkedBy: mockUsers[11].name, number: 'Sales Queue', parkTime: Date.now() - 90000, location: '102' },
        ];
        let loggedInAgentId = 'user001';
        let mockAgentPerformance = { callsToday: 15, avgHandleTimeSeconds: 245, timeInStatusSeconds: 7200, queuesLoggedIn: ['Sales Queue', 'Support Queue'] };
        const loggedInUserIndex = mockUsers.findIndex(u => u.id === loggedInAgentId); if (loggedInUserIndex !== -1) { mockAgentPerformance.status = mockUsers[loggedInUserIndex].status; mockAgentPerformance.statusMessage = mockUsers[loggedInUserIndex].statusMessage; }
        // New mock data for incoming calls
        let mockIncomingCalls = [
            // { incomingId: 'inc_1', callerNumber: '+15552223333', callerName: 'Delta Dynamics', targetType: 'Queue', targetName: 'Support Queue', ringTime: Date.now() - 5000 },
            // { incomingId: 'inc_2', callerNumber: '+15554445555', callerName: null, targetType: 'User', targetName: mockUsers[5].name, ringTime: Date.now() - 12000 },
        ];

        // --- DOM Elements ---
        const sitesContainer = document.getElementById('sites-container');
        const activeCallsContainer = document.getElementById('active-calls-container');
        const callQueuesContainer = document.getElementById('call-queues-container');
        const parkedCallsContainer = document.getElementById('parked-calls-container');
        const incomingCallsContainer = document.getElementById('incoming-calls-container'); // New
        const agentPerformanceContainer = document.getElementById('my-profile-modal-content');
        const lastUpdatedSpan = document.getElementById('last-updated');
        const statTotalUsers = document.getElementById('stat-total-users');
        const statAvailableUsers = document.getElementById('stat-available-users');
        const statOnCallUsers = document.getElementById('stat-on-call-users');
        const statActiveCalls = document.getElementById('stat-active-calls');
        const userSearchInput = document.getElementById('user-search');
        const siteFilterContainer = document.querySelector('.site-filter-group');
        const userSortSelect = document.getElementById('user-sort');
        const usersLoading = document.getElementById('users-loading');
        const dashboardGrid = document.getElementById('dashboard-main-grid');
        const callDetailModal = document.getElementById('call-detail-modal');
        const callModalContent = document.getElementById('call-modal-content');
        const callModalActions = document.getElementById('call-modal-actions');
        const myProfileModal = document.getElementById('my-profile-modal');
        const myProfileBtn = document.getElementById('my-profile-btn');
        let draggedSiteItem = null;
        let draggedPanelItem = null;
        let isFetching = false;

        // --- Helper Functions ---
        function getStatusInfo(status) { /* ... */
            switch (status) { case 'Available': return { class: 'status-available', icon: 'fa-circle-check' }; case 'On Call': return { class: 'status-on-call', icon: 'fa-phone-volume' }; case 'Busy': return { class: 'status-busy', icon: 'fa-circle-minus' }; case 'Away': return { class: 'status-away', icon: 'fa-person-walking-arrow-right' }; case 'DND': return { class: 'status-dnd', icon: 'fa-bell-slash' }; case 'In a Meeting': return { class: 'status-in-a-meeting', icon: 'fa-video' }; case 'Out of Office': return { class: 'status-out-of-office', icon: 'fa-plane-departure' }; case 'Offline': return { class: 'status-offline', icon: 'fa-circle-xmark' }; default: return { class: 'status-offline', icon: 'fa-circle-question' }; }
        }
        function formatDuration(startTime, showSeconds = true, isSecondsInput = false) { /* ... */
             const now = Date.now(); const durationSeconds = isSecondsInput ? startTime : Math.max(0, Math.floor((now - startTime) / 1000)); const minutes = Math.floor(durationSeconds / 60); const seconds = durationSeconds % 60;
             return showSeconds ? `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}` : `${minutes}m ${seconds}s`;
        }
        function formatQueueWaitTime(seconds) { /* ... */
             if (seconds <= 0) return '0s'; const minutes = Math.floor(seconds / 60); const remainingSeconds = seconds % 60; return `${minutes}m ${remainingSeconds}s`;
        }
        function formatDate(dateString) { /* ... */
            if (!dateString) return 'N/A'; try { const date = new Date(dateString); return date.toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' }); } catch (e) { return 'Invalid Date'; }
        }
        function findUserActiveCall(userName) { /* ... */
            return mockActiveCalls.find(call => call.participants.includes(userName));
        }
        function getParticipantInfo(participantIdentifier) { /* ... (same as before) ... */
            if (!participantIdentifier) return { name: 'Unknown', id: null, type: 'unknown' }; if (participantIdentifier.startsWith('+')) { const contact = mockPhonebook[participantIdentifier]; return { name: contact ? contact.name : 'Unknown Caller', id: participantIdentifier, type: 'external' }; } else { const user = mockUsers.find(u => u.name === participantIdentifier); if (user) { return { name: user.name, id: user.extension || null, type: 'internal' }; } else { return { name: participantIdentifier, id: null, type: 'queue' }; } }
        }


        // --- Rendering Functions ---
        function renderUsers() { /* ... (same as before, including jitter fix) ... */
            const selectedSiteCheckboxes = siteFilterContainer.querySelectorAll('.site-filter-checkbox:checked'); let selectedSiteIds = Array.from(selectedSiteCheckboxes).map(cb => cb.value); const isAllSitesSelected = selectedSiteIds.includes('all'); if (isAllSitesSelected) { selectedSiteIds = mockSites.map(s => s.id); } const sortBy = userSortSelect.value; const searchTerm = userSearchInput.value.toLowerCase(); const siteStates = {}; sitesContainer.querySelectorAll('.site-section').forEach(section => { const siteId = section.dataset.siteId; const userList = section.querySelector('.user-list'); if (siteId && userList) { siteStates[siteId] = userList.classList.contains('hidden'); } });
            let expandedUserId = null; let existingDetailView = sitesContainer.querySelector('.user-detail-view'); let detachedDetailView = null; if (existingDetailView) { expandedUserId = existingDetailView.dataset.userId; detachedDetailView = existingDetailView.parentNode.removeChild(existingDetailView); }
            sitesContainer.innerHTML = ''; if (!mockUsers.length || !mockSites.length) { sitesContainer.innerHTML = '<p class="text-gray-500 p-4 text-center">No user or site data available.</p>'; return; } const sitesToRender = mockSites.filter(site => isAllSitesSelected || selectedSiteIds.includes(site.id));
            sitesToRender.forEach(site => { let usersInSite = mockUsers.filter(user => user.siteId === site.id && (searchTerm === '' || user.name.toLowerCase().includes(searchTerm) || (user.extension && user.extension.includes(searchTerm)))); if (usersInSite.length === 0 && !isAllSitesSelected && selectedSiteIds.length > 0 && searchTerm === '') return;
                usersInSite.sort((a, b) => { switch (sortBy) { case 'lastName': const lastNameA = a.name.split(' ').pop(); const lastNameB = b.name.split(' ').pop(); return lastNameA.localeCompare(lastNameB); case 'extension': return (a.extension || '').localeCompare(b.extension || ''); case 'status': const statusOrder = ALL_STATUSES; return (statusOrder.indexOf(a.status) ?? 99) - (statusOrder.indexOf(b.status) ?? 99); case 'firstName': default: return a.name.localeCompare(b.name); } });
                const siteSection = document.createElement('div'); siteSection.className = 'mb-1 rounded-md bg-white site-section'; siteSection.draggable = true; siteSection.dataset.siteId = site.id; const siteHeader = document.createElement('h3'); siteHeader.className = 'text-md font-semibold text-blue-700 site-header rounded-t-md'; const isCollapsed = siteStates[site.id] === true; siteHeader.innerHTML = `<span>${site.name}</span> <span class="site-toggle-icon toggle-icon ${isCollapsed ? 'collapsed' : ''}"><i class="fas fa-chevron-down fa-xs"></i></span>`; siteSection.appendChild(siteHeader); const userList = document.createElement('ul'); userList.className = 'space-y-1 user-list'; if (isCollapsed) { userList.classList.add('hidden'); }
                if (usersInSite.length === 0) { userList.innerHTML = '<li class="text-sm text-gray-500 italic p-2">No matching users in this site.</li>'; }
                else { usersInSite.forEach(user => { const userItem = document.createElement('li'); userItem.className = 'user-item rounded'; userItem.dataset.userId = user.id; const statusInfo = getStatusInfo(user.status); let inlineCallHtml = ''; if (user.status === 'On Call') { const activeCall = findUserActiveCall(user.name); if (activeCall) { const otherPartyInfo = getParticipantInfo(activeCall.participants.find(p => p !== user.name)); inlineCallHtml = `<span class="inline-call-info" title="Call with ${otherPartyInfo.name} ${otherPartyInfo.id && otherPartyInfo.type === 'external' ? '('+otherPartyInfo.id+')' : ''}"> <i class="fas ${activeCall.direction === 'Inbound' ? 'fa-arrow-down' : 'fa-arrow-up'} fa-xs"></i> ${otherPartyInfo.name} </span>`; } }
                        userItem.innerHTML = ` <div class="user-item-clickable flex items-center justify-between text-sm p-2 rounded"> <div class="user-info-left"> <span class="${statusInfo.class} status-icon" title="${user.status}"><i class="fas ${statusInfo.icon}"></i></span> <span class="font-medium text-gray-800 truncate" title="${user.name}">${user.name}</span> <span class="ml-2 text-gray-500 text-xs flex-shrink-0">(Ext: ${user.extension || 'N/A'})</span> </div> <div class="user-info-right"> ${inlineCallHtml} <span class="text-gray-600 font-medium text-xs flex-shrink-0">${user.status}</span> </div> </div> `; userList.appendChild(userItem); userItem.querySelector('.user-item-clickable').addEventListener('click', () => toggleUserDetails(user.id, userItem));
                        if (user.id === expandedUserId && detachedDetailView) { updateUserDetailViewContent(detachedDetailView, user); userItem.parentNode.insertBefore(detachedDetailView, userItem.nextSibling); detachedDetailView.querySelector('.close-detail-btn').addEventListener('click', () => { detachedDetailView.remove(); }); detachedDetailView = null; } }); }
                siteSection.appendChild(userList); sitesContainer.appendChild(siteSection); addSiteDragDropListeners(siteSection); addCollapseListeners(siteHeader, userList, '.site-toggle-icon'); });
            if (sitesContainer.children.length === 0 && (searchTerm !== '' || !isAllSitesSelected)) { sitesContainer.innerHTML = `<p class="text-gray-500 p-4 text-center">No users match the current filters.</p>`; } else if (sitesContainer.children.length === 0) { sitesContainer.innerHTML = '<p class="text-gray-500 p-4 text-center">No users to display.</p>'; }
        }

        function toggleUserDetails(userId, clickedElement) { /* ... (same as before) ... */
            const existingDetailView = sitesContainer.querySelector('.user-detail-view'); const currentlyExpandedId = existingDetailView ? existingDetailView.dataset.userId : null; if (existingDetailView) { existingDetailView.remove(); } if (currentlyExpandedId === userId) { return; } const user = mockUsers.find(u => u.id === userId); if (user) { renderUserDetailView(user, clickedElement); }
        }

        function renderUserDetailView(user, targetElement) { /* ... (same as before) ... */
             const detailView = document.createElement('li'); detailView.className = 'user-detail-view'; detailView.dataset.userId = user.id; updateUserDetailViewContent(detailView, user); targetElement.parentNode.insertBefore(detailView, targetElement.nextSibling); detailView.querySelector('.close-detail-btn').addEventListener('click', () => { detailView.remove(); });
        }

        function updateUserDetailViewContent(detailViewElement, user) { /* ... (same as before) ... */
             const site = mockSites.find(s => s.id === user.siteId); const statusInfo = getStatusInfo(user.status); const profilePicUrl = user.profilePictureUrl || `https://placehold.co/48x48/E2E8F0/A0AEC0?text=${user.name.substring(0, 2).toUpperCase()}`; detailViewElement.innerHTML = ` <div class="flex justify-end mb-1"> <button class="text-gray-400 hover:text-gray-600 text-xs close-detail-btn" aria-label="Close details">&times; Close</button> </div> <div class="flex items-start space-x-3"> <img src="${profilePicUrl}" alt="Profile picture for ${user.name}" width="48" height="48" class="flex-shrink-0 rounded-full border-2 border-white shadow"> <div class="flex-grow min-w-0"> <div class="flex items-baseline mb-1"> <span class="detail-name-site truncate" title="${user.name}">${user.name}</span> <span class="detail-site flex-shrink-0">(${site ? site.name : 'Unknown'})</span> </div> <div class="flex items-center text-sm mb-1"> <span class="${statusInfo.class} status-icon"><i class="fas ${statusInfo.icon}"></i></span> <span class="detail-value">${user.status}</span> </div> ${user.statusMessage ? `<div class="mb-2"><span class="status-message-bubble">${user.statusMessage}</span></div>` : '<div class="mb-2 h-4"></div>'} <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs border-t pt-2 mt-2"> <div><span class="detail-label block text-left">Extension:</span> <span class="detail-value">${user.extension || 'N/A'}</span></div> <div class="truncate" title="${user.email || ''}"><span class="detail-label block text-left">Email:</span> <span class="detail-value">${user.email || 'N/A'}</span></div> <div><span class="detail-label block text-left">Direct #:</span> <span class="detail-value">${user.directNumber || 'N/A'}</span></div> <div></div> </div> </div> </div> <div class="flex justify-start space-x-2 mt-3 pt-2 border-t border-gray-200"> <button class="action-button call-button" ${user.status === 'Offline' ? 'disabled' : ''}><i class="fas fa-phone"></i> Call</button> <button class="action-button chat-button" ${user.status === 'Offline' ? 'disabled' : ''}><i class="fas fa-comment"></i> Chat</button> <button class="action-button text-button" ${!user.directNumber || user.status === 'Offline' ? 'disabled' : ''}><i class="fas fa-mobile-alt"></i> Text</button> </div> `; const closeBtn = detailViewElement.querySelector('.close-detail-btn'); if (closeBtn && !closeBtn.getAttribute('data-listener-attached')) { closeBtn.addEventListener('click', () => { detailViewElement.remove(); }); closeBtn.setAttribute('data-listener-attached', 'true'); }
        }

        function renderActiveCalls() { /* ... (same as before) ... */
            activeCallsContainer.innerHTML = ''; if (mockActiveCalls.length === 0) { activeCallsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No active calls.</p>'; return; }
            mockActiveCalls.forEach(call => { const callItem = document.createElement('div'); callItem.className = 'active-call-item'; callItem.dataset.callId = call.callId; const directionIcon = call.direction === 'Inbound' ? 'fa-arrow-down' : 'fa-arrow-up'; const directionColor = call.direction === 'Inbound' ? 'text-blue-600' : 'text-green-600'; const participant1Identifier = call.participants.find(p => !p.startsWith('+') && !p.includes('Queue')) || call.participants[0]; const participant2Identifier = call.participants.find(p => p !== participant1Identifier); const participant1Info = getParticipantInfo(participant1Identifier); const participant2Info = getParticipantInfo(participant2Identifier); const supervisorActionsHtml = ` <div class="supervisor-actions"> <button class="action-button listen-button" title="Listen In"><i class="fas fa-headphones"></i></button> <button class="action-button whisper-button" title="Whisper"><i class="fas fa-volume-low"></i></button> <button class="action-button barge-button" title="Barge In"><i class="fas fa-phone-alt"></i></button> </div> `; callItem.innerHTML = ` <div class="cursor-pointer space-y-1" data-call-id-clickable="${call.callId}"> <div class="participant-line"> <span class="participant-name truncate" title="${participant1Info.name}">${participant1Info.name}</span> <span class="participant-id">${participant1Info.id ? `(Ext: ${participant1Info.id})` : ''}</span> </div> <div class="participant-line"> <span class="participant-name truncate" title="${participant2Info.name} ${participant2Info.id && participant2Info.type === 'external' ? '('+participant2Info.id+')' : ''}">${participant2Info.name}</span> <span class="participant-id">${participant2Info.id ? (participant2Info.type === 'external' ? participant2Info.id : `(Ext: ${participant2Info.id})`) : ''}</span> </div> <div class="text-gray-600 mt-1 pt-1 border-t border-dashed"> <i class="far fa-clock mr-1 text-gray-400"></i> Duration: <span class="font-medium text-red-600">${formatDuration(call.startTime)}</span> <span class="text-xs px-1.5 py-0.5 rounded flex-shrink-0 inline-flex items-center float-right ${call.direction === 'Inbound' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}"> <i class="fas ${directionIcon} ${directionColor} mr-1 fa-xs"></i> ${call.direction} </span> </div> </div> ${supervisorActionsHtml} `; activeCallsContainer.appendChild(callItem); callItem.querySelector(`[data-call-id-clickable="${call.callId}"]`).addEventListener('click', () => showCallDetails(call.callId)); callItem.querySelector('.listen-button').addEventListener('click', (e) => {e.stopPropagation(); alert(`Simulating: Listen on call ${call.callId}`);}); callItem.querySelector('.whisper-button').addEventListener('click', (e) => {e.stopPropagation(); alert(`Simulating: Whisper on call ${call.callId}`);}); callItem.querySelector('.barge-button').addEventListener('click', (e) => {e.stopPropagation(); alert(`Simulating: Barge on call ${call.callId}`);}); });
        }

        function renderCallQueues() { /* ... (same as before including members) ... */
             callQueuesContainer.innerHTML = ''; if (mockCallQueues.length === 0) { callQueuesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No call queues defined.</p>'; return; }
             mockCallQueues.forEach(queue => { const queueItem = document.createElement('div'); queueItem.className = 'border border-gray-200 p-3 rounded-lg bg-white text-sm shadow-sm space-y-1'; const waitTimeColor = queue.callsWaiting > 0 ? (queue.longestWait > 180 ? 'text-red-600' : 'text-orange-500') : 'text-gray-500'; const memberNames = queue.members .map(memberId => mockUsers.find(u => u.id === memberId)?.name) .filter(name => name) .sort(); const membersHtml = memberNames.length > 0 ? memberNames.map(name => `<span>${name}</span>`).join('') : '<span class="italic text-gray-400">No members</span>'; queueItem.innerHTML = ` <div class="font-semibold text-gray-800">${queue.name}</div> <div class="flex justify-between text-xs"> <span class="text-gray-600"><i class="fas fa-phone-alt mr-1 text-blue-500"></i> Calls Waiting:</span> <span class="font-medium ${queue.callsWaiting > 0 ? 'text-blue-600' : 'text-gray-500'}">${queue.callsWaiting}</span> </div> <div class="flex justify-between text-xs"> <span class="text-gray-600"><i class="fas fa-hourglass-half mr-1 ${waitTimeColor}"></i> Longest Wait:</span> <span class="font-medium ${waitTimeColor}">${formatQueueWaitTime(queue.longestWait)}</span> </div> <div class="flex justify-between text-xs"> <span class="text-gray-600"><i class="fas fa-user-check mr-1 text-green-500"></i> Agents Available:</span> <span class="font-medium text-green-600">${queue.agentsAvailable}</span> </div> <div class="flex justify-between text-xs"> <span class="text-gray-600"><i class="fas fa-user-clock mr-1 text-red-500"></i> Agents Busy:</span> <span class="font-medium text-red-600">${queue.agentsBusy}</span> </div> <div class="queue-member-list"> <strong class="block text-xs mb-1">Members:</strong> <div class="flex flex-wrap gap-1">${membersHtml}</div> </div> `; callQueuesContainer.appendChild(queueItem); });
        }

        function renderParkedCalls() { /* ... (same as before) ... */
            parkedCallsContainer.innerHTML = ''; if (mockParkedCalls.length === 0) { parkedCallsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No calls parked.</p>'; return; }
            mockParkedCalls.forEach(call => { const item = document.createElement('div'); item.className = 'border border-gray-200 p-3 rounded-lg bg-white text-sm shadow-sm space-y-1'; const parkDuration = formatDuration(call.parkTime, true); const parkedNumberDisplay = mockPhonebook[call.number]?.name || call.number; item.innerHTML = ` <div class="flex justify-between items-center"> <span class="font-medium text-gray-800" title="${call.number}">${parkedNumberDisplay}</span> <span class="text-xs text-gray-500">Loc: ${call.location}</span> </div> <div class="text-xs text-gray-600">Parked by: ${call.parkedBy}</div> <div class="text-xs text-gray-600"> <i class="far fa-clock mr-1 text-gray-400"></i> Parked Time: <span class="font-medium">${parkDuration}</span> </div> <div class="mt-2 text-right"> <button class="action-button retrieve-button" data-park-id="${call.parkId}"> <i class="fas fa-phone-arrow-up-right fa-xs"></i> Retrieve </button> </div> `; parkedCallsContainer.appendChild(item); item.querySelector('.retrieve-button').addEventListener('click', (e) => { e.stopPropagation(); alert(`Simulating: Retrieve parked call ${call.parkId}`); mockParkedCalls = mockParkedCalls.filter(p => p.parkId !== call.parkId); renderParkedCalls(); }); });
        }

        function renderIncomingCalls() { /* ... (same as before) ... */
            incomingCallsContainer.innerHTML = ''; if (mockIncomingCalls.length === 0) { incomingCallsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No incoming calls.</p>'; return; }
            mockIncomingCalls.forEach(call => { const item = document.createElement('div'); item.className = 'incoming-call-item space-y-1'; const callerInfo = getParticipantInfo(call.callerNumber); const ringDuration = formatDuration(call.ringTime, false); item.innerHTML = ` <div class="flex justify-between items-center"> <span class="caller-name truncate" title="${callerInfo.name} (${callerInfo.id})">${callerInfo.name}</span> <span class="text-xs text-yellow-700 bg-yellow-100 px-1.5 py-0.5 rounded">Ringing ${ringDuration}</span> </div> <div class="caller-id text-xs">${callerInfo.id}</div> <div class="target-info text-xs"> <i class="fas ${call.targetType === 'Queue' ? 'fa-users' : 'fa-user'} fa-fw mr-1"></i> For: ${call.targetName} </div> <div class="mt-2 text-right"> <button class="action-button call-button text-xs !p-1.5" title="Answer Call"><i class="fas fa-phone"></i> Answer</button> </div> `; incomingCallsContainer.appendChild(item); item.querySelector('.call-button').addEventListener('click', (e) => { e.stopPropagation(); alert(`Simulating: Answer incoming call ${call.incomingId} from ${callerInfo.id}`); mockIncomingCalls = mockIncomingCalls.filter(c => c.incomingId !== call.incomingId); const agent = mockUsers.find(u => u.id === loggedInAgentId); if (agent) { mockActiveCalls.push({ callId: `call_${call.incomingId}`, participants: [agent.name, call.callerNumber], startTime: Date.now(), direction: 'Inbound' }); agent.status = 'On Call'; mockAgentPerformance.status = 'On Call'; mockAgentPerformance.timeInStatusSeconds = 0; } fetchData(); }); });
        }

        function renderAgentPerformance() { /* ... (same as before, renders inside profile modal) ... */
            const agent = mockUsers.find(u => u.id === loggedInAgentId); if (!agent) { agentPerformanceContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Could not load agent data.</p>'; return; } const currentStatus = mockAgentPerformance.status; const statusInfo = getStatusInfo(currentStatus); const currentStatusMessage = mockAgentPerformance.statusMessage || ''; agentPerformanceContainer.innerHTML = ` <div class="flex items-center mb-4"> <img src="${agent.profilePictureUrl}" alt="Agent" width="40" height="40" class="rounded-full mr-3 border"> <span class="font-semibold text-lg">${agent.name}</span> </div> <div class="space-y-3"> <div class="flex items-center justify-between"> <label for="agent-status-select" class="text-gray-600 text-sm font-medium">My Status:</label> <select id="agent-status-select" class="input-base w-1/2"> ${ALL_STATUSES.map(s => `<option value="${s}" ${s === currentStatus ? 'selected' : ''}>${s}</option>`).join('')} </select> </div> <div class="flex items-center justify-between gap-2"> <label for="agent-status-message" class="text-gray-600 text-sm font-medium flex-shrink-0">Message:</label> <input type="text" id="agent-status-message" class="input-base flex-grow" value="${currentStatusMessage}" placeholder="Set status message..."> <button id="save-status-message" class="action-button save-button text-xs !p-1.5" title="Save Message"><i class="fas fa-save"></i></button> </div> <div class="border-t pt-3 mt-3 space-y-1.5"> <div class="flex justify-between"> <span class="text-gray-600"><i class="far fa-clock fa-fw mr-1"></i> Time in Status:</span> <span class="font-medium">${formatDuration(mockAgentPerformance.timeInStatusSeconds, false, true)}</span> </div> <div class="flex justify-between"> <span class="text-gray-600"><i class="fas fa-phone-volume fa-fw mr-1"></i> Calls Today:</span> <span class="font-medium">${mockAgentPerformance.callsToday}</span> </div> <div class="flex justify-between"> <span class="text-gray-600"><i class="fas fa-hourglass-half fa-fw mr-1"></i> Avg Handle Time:</span> <span class="font-medium">${formatDuration(mockAgentPerformance.avgHandleTimeSeconds, false, true)}</span> </div> <div class="pt-1 mt-1 border-t"> <span class="text-gray-600 block mb-1"><i class="fas fa-sign-in-alt fa-fw mr-1"></i> Logged into Queues:</span> <div class="flex flex-wrap gap-1"> ${mockAgentPerformance.queuesLoggedIn.map(q => `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">${q}</span>`).join('') || '<span class="text-xs text-gray-500 italic">None</span>'} </div> </div> </div> </div> `; agentPerformanceContainer.querySelector('#agent-status-select').addEventListener('change', handleAgentStatusChange); agentPerformanceContainer.querySelector('#save-status-message').addEventListener('click', handleStatusMessageSave);
        }

        function updateSummaryStats() { /* ... */
             statTotalUsers.textContent = mockUsers.length; statAvailableUsers.textContent = mockUsers.filter(u => u.status === 'Available').length; statOnCallUsers.textContent = mockUsers.filter(u => u.status === 'On Call').length; statActiveCalls.textContent = mockActiveCalls.length;
        }
        function updateLastUpdatedTime() { /* ... */
             const now = new Date(); lastUpdatedSpan.textContent = now.toLocaleTimeString();
        }

        // --- Modal Functions (Call Detail & Profile) ---
        function showCallDetails(callId) { /* ... (same as before) ... */
            const call = mockActiveCalls.find(c => c.callId === callId); if (!call) return; callModalContent.innerHTML = ''; callModalActions.innerHTML = ''; let contentHtml = `<div class="space-y-2">`; const directionIcon = call.direction === 'Inbound' ? 'fa-arrow-down text-blue-600' : 'fa-arrow-up text-green-600'; contentHtml += `<p><strong>Direction:</strong> <i class="fas ${directionIcon} fa-fw"></i> ${call.direction}</p>`; contentHtml += `<p><strong>Duration:</strong> <span class="font-medium text-red-600">${formatDuration(call.startTime)}</span></p>`; contentHtml += `<p><strong>Participants:</strong></p><ul class="list-disc list-inside ml-4 space-y-1">`; let externalNumberForActions = null; call.participants.forEach(p => { if (p.startsWith('+') && p.length > 8) { const contact = mockPhonebook[p]; externalNumberForActions = p; if (contact) { contentHtml += `<li><i class="fas fa-address-book fa-fw text-gray-400"></i> ${contact.name} (${p})</li>`; } else { contentHtml += `<li><i class="fas fa-phone fa-fw text-gray-400"></i> ${p} (Unknown)</li>`; } } else { const user = mockUsers.find(u => u.name === p); if (user) { const statusInfo = getStatusInfo(user.status); contentHtml += `<li><i class="fas fa-user fa-fw text-gray-400"></i> ${p} <span class="text-xs ml-1">(${user.extension})</span> <span class="${statusInfo.class} ml-2" title="${user.status}"><i class="fas ${statusInfo.icon} fa-xs"></i></span></li>`; } else { contentHtml += `<li><i class="fas fa-users fa-fw text-gray-400"></i> ${p}</li>`; } } }); contentHtml += `</ul>`; if (externalNumberForActions) { const history = mockCallHistory[externalNumberForActions]; if (history) { contentHtml += `<p class="text-xs text-gray-500 mt-2"><i class="fas fa-history mr-1"></i> Last contact: ${formatDate(history.lastContactDate)} by ${history.user}</p>`; } } contentHtml += `</div>`; callModalContent.innerHTML = contentHtml;
            if (externalNumberForActions) { if (mockPhonebook[externalNumberForActions]) { const editBtn = document.createElement('button'); editBtn.className = 'action-button edit-contact-button'; editBtn.innerHTML = `<i class="fas fa-edit fa-xs"></i> Edit Contact`; editBtn.onclick = () => editPhonebookContact(externalNumberForActions); callModalActions.appendChild(editBtn); } else { const addBtn = document.createElement('button'); addBtn.className = 'action-button add-contact-button'; addBtn.innerHTML = `<i class="fas fa-user-plus fa-xs"></i> Add Contact`; addBtn.onclick = () => addPhonebookContact(externalNumberForActions); callModalActions.appendChild(addBtn); } }
            const closeBtn = callModalActions.querySelector('.modal-close-btn-bottom');
            if (!closeBtn) { const newCloseBtn = document.createElement('button'); newCloseBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-md hover:bg-gray-300 modal-close-btn-bottom'; newCloseBtn.textContent = 'Close'; newCloseBtn.onclick = hideCallDetails; callModalActions.appendChild(newCloseBtn); }
            callDetailModal.classList.add('visible');
        }

        function hideCallDetails() { callDetailModal.classList.remove('visible'); }

        function showMyProfileModal() {
            renderAgentPerformance(); // Populate the modal content
            myProfileModal.classList.add('visible');
        }

        function hideMyProfileModal() {
            myProfileModal.classList.remove('visible');
        }

        // --- Phonebook Actions (Simulated) ---
        function addPhonebookContact(number) { /* ... */
            const name = prompt(`Enter name for ${number}:`, ''); if (name) { mockPhonebook[number] = { name: name, added: new Date().toISOString(), notes: 'Added from call' }; alert(`Contact "${name}" added for ${number}.`); renderActiveCalls(); hideCallDetails(); }
        }

        function editPhonebookContact(number) { /* ... */
            const currentContact = mockPhonebook[number]; if (!currentContact) return; const newName = prompt(`Enter new name for ${number}:`, currentContact.name); if (newName && newName !== currentContact.name) { mockPhonebook[number].name = newName; alert(`Contact updated for ${number}.`); renderActiveCalls(); hideCallDetails(); }
        }

        // --- Agent Performance Actions ---
        function handleAgentStatusChange(event) { /* ... (same as before) ... */
            const newStatus = event.target.value; mockAgentPerformance.status = newStatus; mockAgentPerformance.timeInStatusSeconds = 0; const agentIndex = mockUsers.findIndex(u => u.id === loggedInAgentId); if (agentIndex !== -1) { mockUsers[agentIndex].status = newStatus; if (newStatus === 'Available' || newStatus === 'Offline') { mockUsers[agentIndex].statusMessage = null; mockAgentPerformance.statusMessage = null; } } renderAgentPerformance(); renderUsers(); console.log(`Agent status changed to: ${newStatus}`);
        }

        function handleStatusMessageSave() { /* ... (same as before) ... */
            const messageInput = document.getElementById('agent-status-message'); const newMessage = messageInput.value.trim(); mockAgentPerformance.statusMessage = newMessage; const agentIndex = mockUsers.findIndex(u => u.id === loggedInAgentId); if (agentIndex !== -1) { mockUsers[agentIndex].statusMessage = newMessage; } renderAgentPerformance(); renderUsers(); console.log(`Agent status message set to: ${newMessage}`); alert("Status message saved (simulated).");
        }


        // --- Event Listener Setup ---
        function addCollapseListeners(headerElement, contentElement, iconSelector = '.panel-toggle-icon') {
             headerElement.addEventListener('click', (e) => {
                 const dragHandle = headerElement.querySelector('.drag-handle');
                 if (dragHandle && dragHandle.contains(e.target)) { return; }
                 const isHidden = contentElement.classList.toggle('hidden');
                 const iconContainer = headerElement.querySelector(iconSelector);
                 if (iconContainer) { iconContainer.classList.toggle('collapsed', isHidden); }
             });
        }
        function addSiteDragDropListeners(element) { /* ... */
            element.addEventListener('dragstart', handleSiteDragStart); element.addEventListener('dragover', handleSiteDragOver); element.addEventListener('dragleave', handleSiteDragLeave); element.addEventListener('drop', handleSiteDrop); element.addEventListener('dragend', handleSiteDragEnd);
        }
         function addPanelDragDropListeners(element) { /* ... */
            const header = element.querySelector('.panel-header'); const content = element.querySelector('.panel-content'); if (header && content) { addCollapseListeners(header, content); }
            element.addEventListener('dragstart', handlePanelDragStart); element.addEventListener('dragover', handlePanelDragOver); element.addEventListener('dragleave', handlePanelDragLeave); element.addEventListener('drop', handlePanelDrop); element.addEventListener('dragend', handlePanelDragEnd);
        }

        dashboardGrid.querySelectorAll('.dashboard-panel').forEach(addPanelDragDropListeners);
        userSearchInput.addEventListener('input', () => renderUsers());
        // Site filter listeners added in populateSiteFilter
        userSortSelect.addEventListener('change', () => renderUsers());

        // Modal Close Listeners
        callDetailModal.querySelector('.modal-close-btn').addEventListener('click', hideCallDetails);
        callDetailModal.addEventListener('click', (e) => { if (e.target === callDetailModal) { hideCallDetails(); } });
        myProfileModal.querySelector('.modal-close-btn').addEventListener('click', hideMyProfileModal);
        myProfileModal.addEventListener('click', (e) => { if (e.target === myProfileModal) { hideMyProfileModal(); } });
        // Add listeners for bottom close buttons in modals
        callDetailModal.querySelector('.modal-close-btn-bottom').addEventListener('click', hideCallDetails);
        myProfileModal.querySelector('.modal-close-btn-bottom').addEventListener('click', hideMyProfileModal);

        // My Profile Button Listener
        myProfileBtn.addEventListener('click', showMyProfileModal);


        // --- Site Drag and Drop Handlers ---
        function handleSiteDragStart(e) { if (e.target.classList.contains('site-toggle-icon') || e.target.closest('.site-toggle-icon') || e.target.closest('.user-detail-view')) { e.preventDefault(); return; } draggedSiteItem = this; this.classList.add('dragging'); }
        function handleSiteDragOver(e) { e.preventDefault(); this.classList.add('site-drag-over'); }
        function handleSiteDragLeave(e) { this.classList.remove('site-drag-over'); }
        function handleSiteDrop(e) { e.preventDefault(); this.classList.remove('site-drag-over'); if (draggedSiteItem && draggedSiteItem !== this) { const container = this.parentNode; const targetRect = this.getBoundingClientRect(); const mouseOffsetY = e.clientY - targetRect.top; if (mouseOffsetY < targetRect.height / 2) { container.insertBefore(draggedSiteItem, this); } else { container.insertBefore(draggedSiteItem, this.nextSibling); } updateMockSitesOrder(); } }
        function handleSiteDragEnd(e) { if (draggedSiteItem) { draggedSiteItem.classList.remove('dragging'); } draggedSiteItem = null; sitesContainer.querySelectorAll('.site-section').forEach(el => el.classList.remove('site-drag-over')); }
        function updateMockSitesOrder() { const orderedSiteIds = Array.from(sitesContainer.querySelectorAll('.site-section')).map(el => el.dataset.siteId); mockSites.sort((a, b) => orderedSiteIds.indexOf(a.id) - orderedSiteIds.indexOf(b.id)); }

        // --- Panel Drag and Drop Handlers ---
        function handlePanelDragStart(e) {
             const handle = this.querySelector('.drag-handle');
             if (!handle || !handle.contains(e.target)) { e.preventDefault(); return; }
            draggedPanelItem = this; setTimeout(() => this.classList.add('dragging'), 0); e.dataTransfer.effectAllowed = 'move';
        }
        function handlePanelDragOver(e) { e.preventDefault(); this.classList.add('panel-drag-over'); e.dataTransfer.dropEffect = 'move'; }
        function handlePanelDragLeave(e) { this.classList.remove('panel-drag-over'); }
        function handlePanelDrop(e) {
            e.preventDefault(); this.classList.remove('panel-drag-over');
            if (draggedPanelItem && draggedPanelItem !== this) {
                const container = dashboardGrid; const panels = Array.from(container.children); const targetIndex = panels.indexOf(this); const draggedIndex = panels.indexOf(draggedPanelItem);
                if (draggedIndex < targetIndex) { container.insertBefore(draggedPanelItem, this.nextSibling); } else { container.insertBefore(draggedPanelItem, this); }
                 savePanelLayout();
            }
        }
        function handlePanelDragEnd(e) { if (draggedPanelItem) { draggedPanelItem.classList.remove('dragging'); } draggedPanelItem = null; dashboardGrid.querySelectorAll('.dashboard-panel').forEach(el => el.classList.remove('panel-drag-over')); }

        // --- Layout Persistence ---
        function savePanelLayout() { const panelOrder = Array.from(dashboardGrid.querySelectorAll('.dashboard-panel')).map(panel => panel.id); localStorage.setItem('dashboardLayout', JSON.stringify(panelOrder)); console.log("Layout saved:", panelOrder); }
        function loadPanelLayout() { const savedOrder = localStorage.getItem('dashboardLayout'); if (savedOrder) { try { const panelOrder = JSON.parse(savedOrder); const currentPanels = {}; Array.from(dashboardGrid.children).forEach(panel => { currentPanels[panel.id] = panel; panel.remove(); }); panelOrder.forEach(panelId => { if (currentPanels[panelId]) { dashboardGrid.appendChild(currentPanels[panelId]); } }); console.log("Layout loaded."); } catch (e) { console.error("Failed to load layout:", e); } } }


        // --- Initialization and Simulation ---
        function populateSiteFilter() {
            siteFilterContainer.querySelectorAll('label:not(:first-child)').forEach(el => el.remove());
            mockSites.forEach(site => {
                const label = document.createElement('label'); label.className = 'text-sm block';
                label.innerHTML = `<input type="checkbox" class="site-filter-checkbox align-middle" value="${site.id}"> ${site.name}`;
                siteFilterContainer.appendChild(label);
            });
            siteFilterContainer.querySelectorAll('.site-filter-checkbox').forEach(cb => { cb.addEventListener('change', handleSiteFilterChange); });
        }

        function handleSiteFilterChange(event) {
            const allSitesCheckbox = siteFilterContainer.querySelector('.site-filter-checkbox[value="all"]');
            const otherCheckboxes = siteFilterContainer.querySelectorAll('.site-filter-checkbox:not([value="all"])');
            if (event.target.value === 'all') { if (event.target.checked) { otherCheckboxes.forEach(cb => cb.checked = false); } else if (!Array.from(otherCheckboxes).some(cb => cb.checked)) { event.target.checked = true; } }
            else { if (event.target.checked) { allSitesCheckbox.checked = false; } }
            const anyOtherChecked = Array.from(otherCheckboxes).some(cb => cb.checked); if (!anyOtherChecked && !allSitesCheckbox.checked) { allSitesCheckbox.checked = true; }
            renderUsers();
        }


        async function fetchData() {
            if (isFetching) return; isFetching = true; usersLoading.classList.remove('hidden');
            await new Promise(resolve => setTimeout(resolve, 150));
            simulateUpdates();
            renderUsers(); // Render based on current filters/sort
            renderActiveCalls();
            renderCallQueues();
            renderParkedCalls();
            renderIncomingCalls(); // New
            // renderAgentPerformance() called by interval now
            updateSummaryStats();
            updateLastUpdatedTime();
            usersLoading.classList.add('hidden'); isFetching = false;
        }
        function simulateUpdates() { /* ... (same simulation logic) ... */
             if (mockUsers.length > 0 && Math.random() < 0.1) { const userIndex = Math.floor(Math.random() * mockUsers.length); if (mockUsers[userIndex].id === loggedInAgentId) return; const currentStatus = mockUsers[userIndex].status; let newStatus; do { newStatus = ALL_STATUSES[Math.floor(Math.random() * ALL_STATUSES.length)]; } while (newStatus === currentStatus); mockUsers[userIndex].status = newStatus; mockUsers[userIndex].statusMessage = (newStatus === 'Busy' && Math.random() < 0.3) ? 'Deep work' : (newStatus === 'Out of Office' ? 'On PTO' : null); if(newStatus === 'On Call' && !mockActiveCalls.some(call => call.participants.includes(mockUsers[userIndex].name))) { mockActiveCalls.push({ callId: `call_${Math.random().toString(36).substring(7)}`, participants: [mockUsers[userIndex].name, `+1555${Math.floor(1000000 + Math.random() * 9000000)}`], startTime: Date.now(), direction: Math.random() < 0.5 ? 'Inbound' : 'Outbound' }); } else if (currentStatus === 'On Call' && newStatus !== 'On Call') { const callIndex = mockActiveCalls.findIndex(call => call.participants.includes(mockUsers[userIndex].name)); if (callIndex !== -1) { mockActiveCalls.splice(callIndex, 1); } } }
             if (mockActiveCalls.length > 0 && Math.random() < 0.05) { const callIndex = Math.floor(Math.random() * mockActiveCalls.length); const endingCall = mockActiveCalls.splice(callIndex, 1)[0]; const externalNumber = endingCall.participants.find(p => p.startsWith('+')); const internalUser = endingCall.participants.find(p => !p.startsWith('+')); if (externalNumber && internalUser) { mockCallHistory[externalNumber] = { lastContactDate: new Date().toISOString(), user: internalUser }; } endingCall.participants.forEach(pName => { const userIndex = mockUsers.findIndex(u => u.name === pName && u.status === 'On Call'); if (userIndex !== -1) { mockUsers[userIndex].status = 'Available'; } }); }
             mockCallQueues.forEach(q => { if (Math.random() < 0.1) q.callsWaiting = Math.max(0, q.callsWaiting + (Math.random() < 0.5 ? 1 : -1)); if (q.callsWaiting > 0 && Math.random() < 0.2) q.longestWait += Math.floor(Math.random() * 5); else if (q.callsWaiting === 0) q.longestWait = 0; if (Math.random() < 0.05) q.agentsAvailable = Math.max(0, q.agentsAvailable + (Math.random() < 0.5 ? 1 : -1)); if (Math.random() < 0.05) q.agentsBusy = Math.max(0, q.agentsBusy + (Math.random() < 0.5 ? 1 : -1)); });
             if (mockParkedCalls.length > 0 && Math.random() < 0.05) { mockParkedCalls.shift(); } if (mockActiveCalls.length > 0 && Math.random() < 0.03) { const callToPark = mockActiveCalls[0]; const userWhoParks = mockUsers[Math.floor(Math.random()*mockUsers.length)]; mockParkedCalls.push({parkId: `park_${Date.now()}`, parkedBy: userWhoParks.name, number: callToPark.participants.find(p => p.startsWith('+')) || callToPark.participants[1], parkTime: Date.now(), location: userWhoParks.extension.slice(-3)}); }
             if (mockIncomingCalls.length > 0 && Math.random() < 0.1) { mockIncomingCalls.shift(); } if (Math.random() < 0.04 && mockIncomingCalls.length < 3) { const targetType = Math.random() < 0.5 ? 'Queue' : 'User'; const target = targetType === 'Queue' ? mockCallQueues[Math.floor(Math.random() * mockCallQueues.length)].name : mockUsers[Math.floor(Math.random() * mockUsers.length)].name; const callerNum = `+1555${Math.floor(1000000 + Math.random() * 9000000)}`; const callerName = mockPhonebook[callerNum]?.name || null; mockIncomingCalls.push({ incomingId: `inc_${Date.now()}`, callerNumber: callerNum, callerName: callerName, targetType: targetType, targetName: target, ringTime: Date.now() }); }
             mockAgentPerformance.callsToday += (Math.random() < 0.1 ? 1 : 0); mockAgentPerformance.timeInStatusSeconds += 5;
        }

        // Initial Setup
        populateSiteFilter();
        loadPanelLayout();
        fetchData();

        // --- Intervals ---
        setInterval(fetchData, 5000); // Main data refresh
        setInterval(() => {
             // Frequent updates for durations only
             if (mockActiveCalls.length > 0) { renderActiveCalls(); }
             if (mockCallQueues.some(q => q.callsWaiting > 0)) { renderCallQueues(); }
             if (mockParkedCalls.length > 0) { renderParkedCalls(); }
             if (mockIncomingCalls.length > 0) { renderIncomingCalls(); } // Update ringing duration
             renderAgentPerformance(); // Update time in status
        }, 1000);

    </script>

</body>
</html>
