/* Woodson CPQ Shim - embed.min.js
   This file "impersonates" Epicor CPQ's kbmax embed library enough for BisTrack's CPQEmbed.js:
   - provides window.kbmax.ConfiguratorEmbed
   - implements getFields(cb) and saveProduct(cb)
   - renders a simple UI + on-screen debug log
*/

(function () {
  // ---- helpers ----
  function el(tag, attrs = {}, children = []) {
    const e = document.createElement(tag);
    Object.entries(attrs).forEach(([k, v]) => {
      if (k === "style" && typeof v === "object") Object.assign(e.style, v);
      else if (k.startsWith("on") && typeof v === "function") e.addEventListener(k.substring(2), v);
      else if (k === "className") e.className = v;
      else e.setAttribute(k, String(v));
    });
    for (const c of children) e.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
    return e;
  }

  function safeJson(v) {
    try { return JSON.stringify(v, null, 2); } catch { return String(v); }
  }

  // Make sure kbmax namespace exists
  window.kbmax = window.kbmax || {};

  class ConfiguratorEmbed {
    constructor(opts) {
      this.opts = opts || {};
      this.state = {
        description: "TEST: Door Unit (Shim)",
        total: 123.45,
        materials: [
          { part: "Slab", qty: 1, uom: "EA" },
          { part: "Jamb Set", qty: 1, uom: "EA" },
          { part: "Hinges", qty: 3, uom: "EA" }
        ],
        operations: [
          { op: "Hinge Prep", qty: 1 },
          { op: "Bore Prep", qty: 1 }
        ],
        mfgOptions: {
          handing: "RH",
          notes: "Shim output – replace with real door logic later"
        }
      };

      // Attempt to read BisTrack's global lexical binding `inputData` from CPQEmbed.js (often available)
      // If it isn't accessible, no harm done.
      try {
        if (typeof inputData !== "undefined" && inputData) {
          this.state._init = inputData;
          if (inputData.parameters) this.state._parameters = inputData.parameters;
          if (inputData.configuratorID) this.state._configuratorID = inputData.configuratorID;
        }
      } catch {}

      this.mount();
      this.log("ConfiguratorEmbed() created");
      this.log("opts", this.opts);
      if (this.state._init) this.log("inputData (from BisTrack Init)", this.state._init);

      // Add a passive listener just for debug (does not interfere with CPQEmbed.js listener)
      try {
        if (window.chrome && window.chrome.webview) {
          window.chrome.webview.addEventListener("message", (arg) => {
            this.log("WebView message observed", arg && arg.data ? arg.data : arg);
          });
          this.log("Attached debug webview listener");
        } else {
          this.log("chrome.webview not detected (expected if testing in normal browser)");
        }
      } catch (e) {
        this.log("Failed to attach webview listener", e);
      }
    }

    mount() {
      const root = document.getElementById(this.opts.elementId || "viewer");
      if (!root) {
        // last resort: body
        this.root = document.body;
      } else {
        this.root = root;
      }

      // basic styles (no external css dependency)
      const cardStyle = {
        fontFamily: "Segoe UI, Arial, sans-serif",
        border: "1px solid #d0d7de",
        borderRadius: "10px",
        padding: "12px",
        margin: "10px",
        background: "#fff"
      };

      const labelStyle = { fontSize: "12px", opacity: "0.75", marginTop: "8px" };
      const inputStyle = { width: "100%", padding: "8px", borderRadius: "8px", border: "1px solid #c9d1d9" };
      const btnStyle = {
        padding: "8px 10px",
        borderRadius: "8px",
        border: "1px solid #c9d1d9",
        background: "#f6f8fa",
        cursor: "pointer"
      };

      this.logBox = el("pre", {
        style: {
          maxHeight: "220px",
          overflow: "auto",
          background: "#0b1020",
          color: "#d7e3ff",
          padding: "10px",
          borderRadius: "10px",
          fontSize: "12px",
          lineHeight: "1.25"
        }
      });

      this.descInput = el("input", { style: inputStyle, value: this.state.description });
      this.totalInput = el("input", { style: inputStyle, value: String(this.state.total) });

      const materialsArea = el("textarea", {
        style: { ...inputStyle, height: "110px", fontFamily: "Consolas, monospace", fontSize: "12px" }
      });
      materialsArea.value = safeJson(this.state.materials);

      const opsArea = el("textarea", {
        style: { ...inputStyle, height: "110px", fontFamily: "Consolas, monospace", fontSize: "12px" }
      });
      opsArea.value = safeJson(this.state.operations);

      const mfgArea = el("textarea", {
        style: { ...inputStyle, height: "90px", fontFamily: "Consolas, monospace", fontSize: "12px" }
      });
      mfgArea.value = safeJson(this.state.mfgOptions);

      const btnRow = el("div", { style: { display: "flex", gap: "8px", flexWrap: "wrap", marginTop: "10px" } }, [
        el("button", {
          style: btnStyle,
          onclick: () => this.previewGetFields()
        }, ["Preview getFields() payload"]),
        el("button", {
          style: btnStyle,
          onclick: () => this.previewSaveProduct()
        }, ["Preview saveProduct() quote"]),
        el("button", {
          style: btnStyle,
          onclick: () => { this.logBox.textContent = ""; this.log("Log cleared"); }
        }, ["Clear log"])
      ]);

      const header = el("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "center" } }, [
        el("div", {}, [
          el("div", { style: { fontWeight: "700", fontSize: "14px" } }, ["Woodson CPQ Shim (Test)"]),
          el("div", { style: { fontSize: "12px", opacity: "0.75" } }, [
            "Impersonates kbmax.ConfiguratorEmbed for BisTrack CPQEmbed.js"
          ])
        ]),
        el("div", { style: { fontSize: "12px", opacity: "0.65" } }, [
          this.state._configuratorID ? `ConfiguratorID: ${this.state._configuratorID}` : ""
        ])
      ]);

      const card = el("div", { style: cardStyle }, [
        header,

        el("div", { style: labelStyle }, ["Description"]),
        this.descInput,

        el("div", { style: labelStyle }, ["Total (number)"]),
        this.totalInput,

        el("div", { style: labelStyle }, ["BisTrackMaterials (JSON array)"]),
        materialsArea,

        el("div", { style: labelStyle }, ["BisTrackOperations (JSON array)"]),
        opsArea,

        el("div", { style: labelStyle }, ["ManufacturingOptions (JSON object)"]),
        mfgArea,

        btnRow,

        el("div", { style: { marginTop: "10px", fontSize: "12px", opacity: "0.75" } }, [
          "When BisTrack sends GetFields/Submit, CPQEmbed.js will call getFields()/saveProduct() and post results back."
        ]),

        el("div", { style: { marginTop: "10px" } }, [this.logBox])
      ]);

      // store refs for payload generation
      this.materialsArea = materialsArea;
      this.opsArea = opsArea;
      this.mfgArea = mfgArea;

      // mount
      this.root.innerHTML = "";
      this.root.appendChild(card);
    }

    log(title, obj) {
      const ts = new Date().toISOString();
      const line = obj === undefined
        ? `[${ts}] ${title}\n`
        : `[${ts}] ${title}\n${safeJson(obj)}\n`;
      this.logBox.textContent += line;
      this.logBox.scrollTop = this.logBox.scrollHeight;
      try { console.log(title, obj); } catch {}
    }

    // BisTrack expects: getFields(function(fields){ ... })
    getFields(cb) {
      const fields = this.buildFields();
      this.log("getFields() called - returning fields", fields);
      if (typeof cb === "function") cb(fields);
    }

    // BisTrack expects: saveProduct(function(Quote){ ... })
    saveProduct(cb) {
      const quote = this.buildQuote();
      this.log("saveProduct() called - returning quote", quote);
      if (typeof cb === "function") cb(quote);
    }

    buildFields() {
      // CPQEmbed.js only forwards these keys if present:
      // ["BisTrackMaterials","BisTrackOperations","ManufacturingOptions"]
      // It sends them as stringValue, so make them strings (JSON strings work great).
      let materials = this.parseTextarea(this.materialsArea.value, []);
      let operations = this.parseTextarea(this.opsArea.value, []);
      let mfg = this.parseTextarea(this.mfgArea.value, {});

      return {
        BisTrackMaterials: JSON.stringify(materials),
        BisTrackOperations: JSON.stringify(operations),
        ManufacturingOptions: JSON.stringify(mfg)
      };
    }

    buildQuote() {
      const desc = this.descInput.value || "TEST: Door Unit (Shim)";
      const totalNum = Number(this.totalInput.value);
      const total = Number.isFinite(totalNum) ? totalNum : 0;

      // Unknown BisTrack quote schema — start verbose and trim once we see what it consumes.
      return {
        Source: "WoodsonCPQShim",
        Description: desc,
        Total: total,
        Currency: "USD",
        Timestamp: new Date().toISOString(),
        // include the same three payload areas for convenience
        Fields: this.buildFields(),
        // echo init/parameters for debugging
        Debug: {
          configuratorId: this.opts.configuratorId,
          parameters: this.opts.parameters,
          configuredProduct: this.opts.configuredProduct
        }
      };
    }

    parseTextarea(text, fallback) {
      try {
        const v = JSON.parse(text);
        return v;
      } catch {
        return fallback;
      }
    }

    previewGetFields() {
      this.log("Preview getFields()", this.buildFields());
    }

    previewSaveProduct() {
      this.log("Preview saveProduct()", this.buildQuote());
    }
  }

  window.kbmax.ConfiguratorEmbed = ConfiguratorEmbed;
})();
